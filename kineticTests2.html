
<!--
  Tutorials:
  http://jsfiddle.net/robtown/SGQq7/22/
-->
<!DOCTYPE HTML>
<html>
    <head>
        <style>
            body {
                margin: 0px;
                padding: 0px;
            }
            canvas {
                border: 1px solid #9C9898;
            }
        </style>
        <script src="src/lib/kinetic-v4.0.5.min.js"></script>
        <script>
            imageCount = 0;

            var DRAWABLE_X_MIN = 0;
            var DRAWABLE_X_MAX = 700; // 708 - strict border
            var DRAWABLE_Y_MIN = 240; // 230 - strict border
            var DRAWABLE_Y_MAX = 1024;
            var DEFAULT_MODE = "draw";  // undefined
            var STAGE_X = 768;  //768
            var STAGE_Y = 1024; //1024

            var HISTORY_BASE_X = DRAWABLE_X_MAX;
            var HISTORY_BASE_Y = DRAWABLE_Y_MIN + 196;
            var HISTORY_ITEM_DIM = 64;

            function isInDrawableArea(myX, myY) {
              up = {
                x : myX,
                y : myY
              };

              
              if ((DRAWABLE_X_MIN <= up.x && up.x <= DRAWABLE_X_MAX) && (DRAWABLE_Y_MIN <= up.y && up.y <= DRAWABLE_Y_MAX)) {
                return true;
              } else {
                console.log("not in drawable area: ", up.x, up.y );  
                return false;
              }
            }

            window.onload = function() {
              var lowY = DRAWABLE_Y_MIN;
              var highY = DRAWABLE_Y_MIN;

              var newLine;
              var newLinePoints = [];
              var prevPos;
              var mode = DEFAULT_MODE;
              
              var historyYOffset = HISTORY_BASE_Y;

              document.getElementById("drawMode").addEventListener("click", function() {
                mode = "draw";
              }, false);

              document.getElementById("eraseMode").addEventListener("click", function() {
                mode = "erase";
              }, false);

                layer = new Kinetic.Layer();
                loadedImageLayer = new Kinetic.Layer();  // For re-loaded thumbs
                linesLayer = new Kinetic.Layer();
                textLayer = new Kinetic.Layer();
                controlsLayer = new Kinetic.Layer();

                var simpleText = new Kinetic.Text({
                  x: 190,
                  y: 15,
                  text: "Simple Text",
                  fontSize: 30,
                  fontFamily: "Calibri",
                  textFill: "green"
                });

                var complexText = new Kinetic.Text({
                  x: 100,
                  y: 60,
                  stroke: '#555',
                  strokeWidth: 5,
                  fill: '#ddd',
                  text: 'COMPLEX TEXT\n\nAll the world\'s a stage, and all the men and women merely players. They have their exits and their entrances.',
                  fontSize: 14,
                  fontFamily: 'Calibri',
                  textFill: '#555',
                  width: 380,
                  padding: 20,
                  align: 'center',
                  fontStyle: 'italic',
                  shadow: {
                    color: 'black',
                    blur: 1,
                    offset: [10, 10],
                    opacity: 0.2
                  },
                  cornerRadius: 10
                });

                stage = new Kinetic.Stage({
                    container: "container",
                    width: STAGE_X,
                    height: STAGE_Y
                });
                GloStage = stage;

                background = new Kinetic.Rect({
                    x: 0, 
                    y: 0, 
                    width: stage.getWidth(),
                    height: stage.getHeight(),
                    fill: "white"
                });
    
                layer.add(background);

                // Load background image for OPD
                var imageObj = new Image();
                imageObj.onload = function() {
                  console.log("image loaded");
                  console.log(stage.getWidth(), stage.getHeight());
                  var backgroundImage = new Kinetic.Image({
                    x: 0,
                    y: 0,
                    image: imageObj,
                    width: stage.getWidth(),
                    height: stage.getHeight()
                  });
                  layer.add(backgroundImage);
                  layer.draw();
                }
                var file = "2012.11.07_OPD-Lite_v1.0.jpg";
                imageObj.src = file;

                stage.add(layer);
                stage.add(linesLayer);
                stage.add(textLayer); // in front of "draw" layer, i.e. cant draw on a diagnosis. for now.
                stage.add(loadedImageLayer);
                stage.add(controlsLayer);
                
                moving = false;

                // Drag start
                stage.on("mousedown", function(){
                  dragStart();
                });

                stage.on("touchstart", function(){
                  dragStart();
                });

                function dragStart() {
                    console.log('dragStart');

                    var up = stage.getUserPosition();
                    if (! isInDrawableArea(up.x, up.y)) {
                      return;
                    }
                    
                    if (mode !== 'draw') {
                      return;
                    }

                    if (moving){
                        moving = false;layer.draw();
                    } else {
                        newLinePoints = [];
                        prevPos = stage.getUserPosition();  // Mouse or touch
                        newLinePoints.push(prevPos);
                        newLine = new Kinetic.Line({
                          points: newLinePoints,
                          stroke: "red",
                        });
                        linesLayer.add(newLine);

                        moving = true;    
                        // linesLayer.drawScene();            

                        // // TODO: Allow erase of lines..
                        // newLine.on('mouseover', function(evt){
                        //   console.log('clicked on newline');
                        //   if (mode == 'erase') {
                        //     console.log('fake erase');
                        //   }
                        // });                        
                    }
                  }

                // Keep track of current low and high
                function updateBounds(mousePos) {
                    var y = mousePos.y;
                    if (y < lowY || lowY == undefined) { lowY = y; }
                    if (y > highY || highY == undefined) { highY = y; console.log("hi = " + y)}
                }


                // Drag in progress
                stage.on("mousemove", function(){ dragMove(); });
                stage.on("touchmove", function(){ dragMove(); });

                function dragMove(){
                    var up = stage.getUserPosition();
                    if (! isInDrawableArea(up.x, up.y)) {
                      return;
                    }

                    // console.log('dragMove');
                    if (mode !== 'draw') {
                      return;
                    }

                    if (moving) {
                        var mousePos = stage.getUserPosition();  // Mouse or touch
                        var x = mousePos.x;
                        var y = mousePos.y;
                        newLinePoints.push(mousePos);
                        updateBounds(mousePos);
                        prevPos = mousePos;
                        
                        moving = true;
                        linesLayer.drawScene();
                    }
                }
                
                // Done dragging
                stage.on("mouseup", function(){dragComplete();});
                stage.on("touchend", function(){dragComplete();});
                
                function dragComplete(){
                    console.log('drag complete');
                    
                    var up = stage.getUserPosition();
                    if (! isInDrawableArea(up.x, up.y)) {
                      return;
                    }

                    if (mode !== 'draw') {
                      return;
                    }

                    moving = false; 
                }

                document.getElementById("saveCanvas").addEventListener("click", function() {
                  /*
                   * since the stage toDataURL() method is asynchronous, we need
                   * to provide a callback
                   */
                  stage.toDataURL({
                    callback: function(dataUrl) {
                      /*
                       * here you can do anything you like with the data url.
                       * In this tutorial we'll just open the url with the browser
                       * so that you can see the result as an image
                       */
                      // localStorage.setItem('imageFromVisit' + imageCount, dataUrl);
                      createThumbnail('thumbImg' + imageCount, dataUrl);
                      imageCount++;
                    }
                  });
                }, false);

                // Creating thumbnails..
                // 'canvasImg'
                function createThumbnail(imgId, dataUrl) {
                  var dim = 64;
                  img = document.getElementById(imgId);
                  img.height = dim;
                  img.width = dim;
                  img.src = dataUrl;
                  // img.setAttribute('onclick', 'loadImageFromPriorVisit("' + dataUrl + '");')

                  addHistoryItem('name','yellow', dataUrl);
                }

                // Load 
                function addHistoryItem(name, color, dataUrl) {
                  if (! dataUrl ) {
                    var box = new Kinetic.Rect({
                      x: DRAWABLE_X_MAX,
                      y: historyYOffset,
                      width: HISTORY_ITEM_DIM,
                      height: HISTORY_ITEM_DIM,
                      fill: color,  // Today
                      stroke: "black",
                      strokeWidth: 4,
                      draggable: false,
                      // name: 'thumb'
                    });
                    updateHistoryBar(box, '');
                    return;
                  }

                  // If there is a dataUrl, then use that image to do fun stuff like create thumbz
                  var imageObj = new Image();
                  imageObj.onload = function() {
                    var box = createHistoryLink(imageObj);
                    updateHistoryBar(box, dataUrl);
                  }
                  imageObj.src = dataUrl;

                  function createHistoryLink(dataUrl) {
                    var box = new Kinetic.Image({
                      x: DRAWABLE_X_MAX,
                      y: historyYOffset,
                      width: HISTORY_ITEM_DIM,
                      height: HISTORY_ITEM_DIM,
                      stroke: "black",
                      strokeWidth: 4,
                      image: dataUrl
                      // name: 'thumb'
                    });
                    return box;
                  }

                  function updateHistoryBar(box, dataUrl) {
                    controlsLayer.add(box);
                    controlsLayer.draw();
                    box.on('click', function() {
                      // Reset to current visit
                      loadImageFromPriorVisit(dataUrl);
                    });
                    
                    historyYOffset += HISTORY_ITEM_DIM + (HISTORY_ITEM_DIM / 2);
                  }
                }

                addHistoryItem('today', 'green', '');

                function loadImageFromPriorVisit(dataUrl) {
                  console.log('loadImageFromPriorVisit');
                  if (! dataUrl) {
                    console.log('no data url');
                    // Reset to draw mode
                    // console.log(loadedImageLayer.getChildren());
                    // loadedImageLayer.removeChildren();
                    // loadedImageLayer.clear();
                    loadedImageLayer.hide();
                    // loadedImageLayer.draw();

                    // For now, reset the drawing layers..
                    // TODO: There may be times when we want to persist ('today in progress') and look
                    //   back at history
                    linesLayer.removeChildren();
                    textLayer.removeChildren();
                    
                    highY = DRAWABLE_Y_MIN; // Also reset highY, so that text will appear in correct place relative to doctor handwriting
                    stage.draw();
                    return;
                  }
                  
                  
                  var imageObj = new Image();
                  imageObj.onload = function() {
                    console.log("image loaded");
                    
                    var priorVisitImage = new Kinetic.Image({
                      x: 0,
                      y: 0,
                      image: imageObj,
                      width: stage.getWidth(),
                      height: stage.getHeight()
                    });
                    
                    loadedImageLayer.add(priorVisitImage);
                    loadedImageLayer.draw();
                  }
                  imageObj.src = dataUrl;

                  loadedImageLayer.show();
                }

                document.getElementById("addDiagnosis").addEventListener("click", function() {
                  // Get user input
                  console.log("add diagnosis")
                  // var input = window.prompt("What's the diagnosis?","Tuberculosis");
                  
                  // inserts a dianosis wherever there's untouched space on canvas
                  drawTextAtLowPoint("FAKE DIAGNOSIS 123");
                  // drawTextAtLowPoint(input);

                }, false);

                function drawTextAtLowPoint(text) {
                  console.log("drawTextAtLowPoint");
                  
                  // add the shapes to the layer
                  simpleText.setAttrs({y: highY});
                  console.log(simpleText);
                  console.log(simpleText.y);
                  textLayer.add(simpleText);
                  complexText.setAttrs({y: highY + 45});
                  textLayer.add(complexText);
                  stage.draw();
                } 
            };
        </script>
    </head>
    <body>
        <div id="container" ></div>
        <button id="drawMode">
          Draw
        </button>
        <button id="eraseMode">
          Erase
        </button>
        <button id="saveCanvas">
          saveCanvas
        </button>
        <button id="addDiagnosis">
          + Diagnosis
        </button>
        <div id="thumbs">
          <a id='thumbLink1' href='#'>
            <img border="1" id="thumbImg0" alt="Right click to save me!">
            <img border="1" id="thumbImg1" alt="Right click to save me!">
            <img border="1" id="thumbImg2" alt="Right click to save me!">
            <img border="1" id="thumbImg3" alt="Right click to save me!">
            <img border="1" id="thumbImg4" alt="Right click to save me!">
          </a>
        </div>
    </body>
</html>